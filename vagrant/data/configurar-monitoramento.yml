---
- name: Configurar o nodeJS nos servers
  hosts: servers
  become: yes

  tasks:
    - name: Retirar o diretório de instalação antigo
      file:
        path: /tmp/nagios
        state: absent
      become: true
    - name: Retirar o diretório de instalação semi-criado
      file:
        path: /tmp/nagios-4.4.5
        state: absent
      become: true
    - name: Retirar o antigo arquivo de instalação
      file:
        path: /tmp/nagios.tar.gz
        state: absent
      become: true
    - name: Atualizar apt
      apt: 
        name: '*'
        update_cache: yes
      become: true 
    - name: Instalar os requisitos do nagios via apt para o ubuntu 18.04
      apt:
        name: 
          - autoconf
          - gcc
          - libc6
          - make
          - wget
          - unzip
          - libssl-dev
          - apache2
          - php
          - libapache2-mod-php*
          - libgd-dev
          - build-essential
        state: latest
        force: true
        update_cache: true
      become: true
    - name: Baixar e descompactar
      shell: cd /tmp;rm nagios*.tar.gz;wget -O nagios.tar.gz --no-check-certificate https://assets.nagios.com/downloads/nagioscore/releases/nagios-4.4.5.tar.gz;tar -zxf nagios.tar.gz;mv nagios-4.4.5 nagios
      become: true
    - name: Configurar e executar makeall
      shell: cd /tmp/nagios;./configure --with-mail=/usr/sbin/sendmail --with-httpd-conf=/etc/apache2/sites-enabled;make all;
      become: true
    - name: Criar usuários e grupos
      command: chdir=/tmp/nagios make install-groups-users
      become: true
    - name: Criar diretório para usuários do nagios
      file:
        path: /home/nagios
        state: directory
        owner: nagios
        group: nagios
        mode: 0775
      become: true
    - name: Alterar o diretório inicial do usuário do nagios e adicionar membros do grupo
      command: "{{ item }}"
      with_items: 
        - usermod --home /home/nagios nagios
        - usermod -a -G nagios www-data
      become: true
    - name: make binários
      command: chdir=/tmp/nagios {{ item }}
      with_items:
        - make install
        - make install-daemoninit 
        - make install-commandmode
        - make install-config
        - make install-webconf
      become: true
    - name: Habilitar módulos apache2
      apache2_module: state=present name={{ item }}
      with_items:
        - cgi
        - rewrite
    - name: Restart no serviço do Apache2
      service:
        name: apache2
        state: restarted
      become: true
    - name: Criar conta de usuário nagiosadmin (usuário apache)
      command: htpasswd -cb /usr/local/nagios/etc/htpasswd.users nagiosadmin nagios
      become: true
    - name: Copiar manipuladores de eventos
      shell: ln -s /tmp/nagios/contrib/eventhandlers/* /usr/local/nagios/libexec/
      become: true
    - name: Alterar propriedade e permissões
      file:
        path: /usr/local/nagios/libexec/eventhandlers/
        owner: nagios
        group: nagios
        mode: u+rw,g+rw,o+r
        recurse: true
      become: true
    - name: Iniciar o serviço Nagios
      service:
        name: nagios
        state: restarted
      become: true
    - name: Instalar os requisitos do nagios via apt para o ubuntu 18.04
      apt:
        name: 
          - autoconf
        state: latest
        force: true
        update_cache: true
    - name: Remover o diretório da antiga instalação
      file:
         path: /tmp/nagios-plugins
         state: absent
      become: true
    - name: Remover o diretório de instalação semi-criada
      file:
        path: /tmp/nagios-plugins-release-2.3.3
        state: absent
      become: true
    - name: Remover o antigo arquivo de instalação
      file:
        path: /tmp/nagios-plugins.tar.gz
        state: absent
      become: true
    - name: Atualizar apt
      apt: 
        name: '*'
        update_cache: yes
      become: true 
    - name: Instale os plugins Nagios Reqs
      apt:
        name: 
          - autoconf
          - gcc
          - libc6
          - libmcrypt-dev
          - make
          - wget
          - bc
          - gawk
          - dc
          - snmp
          - libssl-dev
          - libnet-snmp-perl
          - gettext
          - libldap2-dev
          - dnsutils
          - build-essential
          - smbclient
          - fping
        state: latest
        force: true
        update_cache: true
      become: true
    - name: baixar e descompactar
      shell: cd /; cd /tmp;rm nagios-plugin*.tar.gz;wget -O nagios-plugins.tar.gz --no-check-certificate https://github.com/nagios-plugins/nagios-plugins/archive/release-2.3.3.tar.gz;tar -zxf nagios-plugins.tar.gz;mv nagios-plugins-release-2.3.3 nagios-plugins
      become: true
    - name: configurar e rodar o make
      command: chdir=/tmp/nagios-plugins {{ item }} 
      with_items:
        - ./tools/setup
        - ./configure
        - make
        - make install
      become: true
    - name: Remover o diretório da antiga instalação
      file:
        path: /tmp/nrpe*
        state: absent
      become: true
    - name: Remover o diretório de instalação semi-criada
      file:
        path: /tmp/nrpe-npre-4.0.2
        state: absent
      become: true
    - name: Remover o antigo arquivo de instalação
      file:
        path: /tmp/nrpe.tar.gz
        state: absent
      become: true
    - name: Atualizar apt
      apt: 
        name: '*'
        update_cache: yes
      become: true 
    - name: Instale o NRPE Reqs
      apt:
        name: 
          - autoconf
          - gcc
          - libc6
          - libmcrypt-dev
          - make
          - wget
          - libssl-dev
          - openssl 
        state: latest
        force: true
        update_cache: true
      become: true
    - name: baixar e descompactar
      shell: cd /;cd /tmp;rm nrp*.tar.gz;wget -O nrpe.tar.gz --no-check-certificate https://github.com/NagiosEnterprises/nrpe/archive/nrpe-4.0.2.tar.gz;tar -zxf nrpe.tar.gz;mv nrpe-nrpe-4.0.2 nrpe
      become: true
    - name: Configure e faça o plugin check_nrpe, depois mova-o para o diretório de plugins.
      command: chdir=/tmp/nrpe {{ item }} 
      with_items:
        - ./configure --enable-command-args --with-ssl=/usr/bin/openssl --with-ssl-lib=/usr/lib/x86_64-linux-gnu
        - make check_nrpe
        - make install-plugin
      become: true
    - name: Adicionar definição de serviços
      command: "{{ item }}"
      with_items:
        - sh -c "echo >> /etc/services"
        - sh -c "sudo echo '# Nagios services' >> /etc/services"
        - sh -c "sudo echo 'nrpe    5666/tcp' >> /etc/services"
      become: true
    - name: Alterar o endereço de e-mail default de notificação
      shell: cd /;cd /usr/local/nagios/etc/objects;sudo sed -i 's+nagios@localhost+montjpedro@gmail.com+g' contacts.cfg
      become: true
    - name: Adicionar serviços de alerta ao e-mail
      shell: cd /;cd /usr/local/nagios/etc/objects;sudo sed -i 's+montjpedro@gmail.com ;+montjpedro@gmail.com;service_notification_period             24x7;service_notification_options            w,u,c,r,f,s;service_notification_commands           notify-service-by-email;host_notification_period                24x7;host_notification_options               d,u,r,f,s;host_notification_commands              notify-host-by-email;+g' contacts.cfg
      become: true